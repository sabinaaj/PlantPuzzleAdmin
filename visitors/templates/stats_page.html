{% extends 'base.html' %}
{% load static %}

{% block content %}

{% include 'navbar.html' %}

<div class="container max-w-6xl mx-auto pt-10">

    <h1 class="text-3xl font-bold text-gray-700 px-1">Statistika</h1>

    <div class="grid gap-4 lg:gap-8 md:grid-cols-3 py-8">
        <div class="relative p-6 rounded-xl bg-white shadow-md space-y-2">
            <div
                class="flex items-center space-x-2 rtl:space-x-reverse text-sm font-medium text-gray-500">
                <span>Počet návštěvníků</span>
            </div>

            <div class="text-3xl">
                {{ visitors_cnt }}
            </div>
        </div>

        <div class="relative p-6 rounded-xl bg-white shadow-md space-y-2">
            <div
                class="flex items-center space-x-2 rtl:space-x-reverse text-sm font-medium text-gray-500">
                <span>Dokončených testů</span>
            </div>

            <div class="text-3xl">
                {{ done_cnt }}
            </div>
        </div>

        <div class="relative p-6 rounded-xl bg-white shadow-md space-y-2">
            <div
                class="flex items-center space-x-2 rtl:space-x-reverse text-sm font-medium text-gray-500">
                <span>Průměrná úspěšnost</span>
            </div>

            <div class="text-3xl">
                {{ avg_rate }} %
            </div>
        </div>
    </div>

    <div class="my-4 px-1 flex justify-between items-center">
        <div class ="text-2xl font-bold text-gray-700">
            Přehled za

            <select id="timeRangeDropdown" class="border rounded px-2 py-1">
                <option value="all">Celé období</option>
                <option value="today">Dnes</option>
                <option value="week">Poslední týden</option>
                <option value="month">Poslední měsíc</option>
            </select>
        </div>

        <button class="bg-pistachio-500 text-white px-3 py-2 rounded hover:bg-pistachio-600 shadow">
            <i class="fas fa-download pr-2"></i>
            Stáhnout přehled
        </button>

    </div>

    {% for area in areas %}
    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
        <div class="flex items-center space-x-4">
            {% if area.icon %}
                <img src="{{ area.icon.url }}" alt="{{ area.title }}" class="h-14">
            {% else %}
                <img src="{% static 'area_placeholder.png' %}" class="h-14">
            {% endif %}
            <h3 class="text-2xl font-semibold">{{ area.title }}</h3>
        </div>

        <div class="grid grid-cols-2 gap-6 mt-4">
            <div class="grid gap-4 md:grid-cols-2">
                <div class="p-6 space-y-2 relative">
                    <div class="flex items-center space-x-2 text-sm font-medium text-gray-500">
                        <span>Dokončených pracovních listů</span>
                    </div>
                    <div id="done-cnt-{{ area.pk }}" class="text-3xl">0</div>
                    <div class="absolute top-0 right-0 h-24 border-r border-gray-300"></div>
                </div>
                <div class="p-6 space-y-2">
                    <div class="flex items-center space-x-2 text-sm font-medium text-gray-500">
                        <span>Průměrná úspěšnost</span>
                    </div>
                    <div id="avg-rate-{{ area.pk }}" class="text-3xl">0</div>
                </div>
            </div>
            <div>
                <canvas id="chart-{{ forloop.counter }}"></canvas>
            </div>
        </div>

        <h4 class="mt-6 text-lg font-semibold">Pracovní listy</h4>

        <div class="mt-4 space-y-4">
            {% for worksheet in area.worksheet_set.all %}
                <div class="bg-gray-100 p-4 rounded-xl">
                    <h5 class="text-md font-semibold text-gray-800">{{ worksheet.title }}</h5>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="p-4 space-y-2 relative">
                                <div class="flex items-center space-x-2 text-sm font-medium text-gray-500">
                                    <span>Vyplněno</span>
                                </div>
                                <div class="text-2xl">120</div>
                                <div class="absolute top-0 right-0 h-20 border-r border-gray-300"></div>
                            </div>
                            <div class="p-4 space-y-2">
                                <div class="flex items-center space-x-2 text-sm font-medium text-gray-500">
                                    <span>Průměrná úspěšnost</span>
                                </div>
                                <div class="text-2xl">78%</div>
                            </div>
                        </div>
                        <div>
                            <canvas id="worksheet-chart-{{ forloop.parentloop.counter }}-{{ forloop.counter }}"></canvas>
                        </div>
                    </div>
                </div>
            {% empty %}
                <p class="text-gray-500">Žádné pracovní listy nebyly nalezeny.</p>
            {% endfor %}
        </div>
    </div>
{% empty %}
    <p class="text-gray-500">Žádné oblasti nebyly nalezeny.</p>
{% endfor %}

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

    document.addEventListener("DOMContentLoaded", function() {
        const dropdown = document.getElementById("timeRangeDropdown");
        getData(dropdown);

        dropdown.addEventListener("change", function () {
            getData(dropdown);
    });

        {% for area in areas %}
            {% for worksheet in area.worksheet_set.all %}
            new Chart(document.getElementById("worksheet-chart-{{ forloop.parentloop.counter }}-{{ forloop.counter }}"), {
                type: 'bar',
                data: {
                    labels: ["Otázka 1", "Otázka 2", "Otázka 3"],
                    datasets: [{
                        label: "Úspěšnost",
                        data: [80, 90, 70],
                        backgroundColor: "rgba(255, 99, 132, 0.6)"
                    }]
                }
            });
            {% endfor %}
        {% endfor %}
    });

    function getData(dropdown) {
        const selectedRange = dropdown.value;

         fetch(`/visitors/stats/fetch/?range=${selectedRange}`)
            .then(response => response.json())
            .then(responseData => {
                console.log("API Response:", responseData);
                const data = responseData.data;

            let areaId;
            {% for area in areas %}
                areaId = "{{ area.pk }}";
                console.log("Processing area:", areaId);

                if (data[areaId]) {
                    document.getElementById(`done-cnt-${areaId}`).textContent = data[areaId]['done_cnt'] || 0;
                    document.getElementById(`avg-rate-${areaId}`).textContent = (data[areaId]['avg_rate'] || 0) + " %";
                } else {
                    console.warn(`Žádná data pro oblast ${areaId}`);
                    document.getElementById(`done-cnt-${areaId}`).textContent = "0";
                    document.getElementById(`avg-rate-${areaId}`).textContent = "0 %";
                }

                new Chart(document.getElementById(`chart-${areaId}`), {
                    type: 'bar',
                    data: {
                        labels: data[areaId]['worksheet_labels'],
                        datasets: [{
                            label: "Úspěšnost",
                            data: [65, 75, 85],
                            backgroundColor: "rgba(54, 162, 235, 0.6)"
                        }]
                    }
                });
            {% endfor %}

            })
            .catch(error => {
                console.error("Chyba při načítání statistik:", error);
                alert("Nepodařilo se načíst statistiky.");
            });
    }

</script>

{% endblock %}
